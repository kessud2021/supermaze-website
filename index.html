<!-- SuperMaze v1.3.1 - Token-Based Multiplayer + Singleplayer -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title id="page-title">SuperMaze v1.3.1</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
*{box-sizing:border-box}html,body{height:100%;margin:0;font-family:'Segoe UI',sans-serif}body{display:flex;justify-content:center;align-items:center;transition:background .3s ease;min-height:100vh}.connect-container{display:flex;justify-content:center;align-items:center;height:100%}.connect-card{width:380px;border-radius:14px;box-shadow:0 12px 36px rgba(2,6,23,.36);backdrop-filter: blur(8px);background: rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.06)}.maze-container{width:100%;height:100vh;position:relative;display:flex;justify-content:center;align-items:center;background:#f5f5f5;overflow:hidden}.maze-grid{display:grid;gap:2px}.cell{width:25px;height:25px;border-radius:6px;background:#fff;transition:background .06s;box-sizing:border-box}.cell.wall{background:#333}.cell.player{background:#e74c3c;box-shadow:0 0 6px rgba(231,76,60,.7) inset}.cell.end{background:#2ecc71;box-shadow:0 0 6px rgba(46,204,113,.6) inset}.cell.ghost{background: rgba(0,200,255,0.6)}.keystrokes{position:absolute;bottom:18px;left:18px;display:flex;gap:6px;flex-direction:column;color:#fff;font-weight:700;text-shadow:0 0 5px #000}.keystrokes span{width:34px;height:34px;text-align:center;line-height:34px;border-radius:6px;border:1px solid rgba(255,255,255,.9);background:rgba(0,0,0,.55)}.stopwatch{position:absolute;top:14px;right:14px;padding:6px 10px;border-radius:8px;background:rgba(0,0,0,.7);color:#fff;font-size:18px}.back-btn{position:absolute;top:14px;left:14px}@media (max-width:480px){.connect-card{width:92%}.connect-card.small{width:92%}}.title-row{display:flex;align-items:center;justify-content:space-between;gap:8px}.title-left{display:flex;align-items:center;gap:10px}.site-title{font-size:20px;font-weight:700;margin:0}.status-pill{padding:6px 10px;border-radius:999px;font-weight:700;font-size:13px;display:inline-flex;align-items:center;gap:8px}.status-online{background: rgba(16,185,129,0.14); color:#10b981; border:1px solid rgba(16,185,129,0.22)}.status-offline{background: rgba(239,68,68,0.12); color:#ef4444; border:1px solid rgba(239,68,68,0.18)}.join-card .form-control{background: rgba(255,255,255,0.04); color:inherit; border-radius:10px; border:1px solid rgba(255,255,255,0.06)}.join-actions{display:flex;gap:8px;margin-top:10px}.btn-ghost{background: rgba(255,255,255,0.03); color:inherit; border:1px solid rgba(255,255,255,0.06)}
</style>
</head>
<body class="theme-light">

<!-- USERNAME SCREEN -->
<div id="username-screen" class="connect-container">
  <div class="card connect-card text-center p-0">
    <div class="card-body">
      <div class="title-row mb-2">
        <div class="title-left">
          <h4 class="site-title">ðŸŒ€ SuperMaze</h4>
        </div>
        <div>
          <span id="global-status" class="status-pill status-offline">ðŸ”Œ Offline</span>
        </div>
      </div>
      <div class="mb-3"><small>Enter your username to continue</small></div>
      <input id="username-input" class="form-control mb-3" placeholder="Your username" />
      <button id="continue-btn" class="btn btn-primary w-100">Continue</button>
    </div>
  </div>
</div>

<!-- CONNECT SCREEN -->
<div id="connect-screen" class="connect-container d-none">
  <div class="card connect-card p-0">
    <div class="card-body">
      <div class="title-row mb-2">
        <div class="title-left">
          <h4 class="site-title">ðŸŒ€ SuperMaze</h4>
          <small class="text-muted ms-2">v1.3.1</small>
        </div>
        <div>
          <span id="server-status-pill" class="status-pill status-offline">ðŸ”Œ Server</span>
        </div>
      </div>

      <div class="text-center mb-3">
        <button id="single-btn" class="btn btn-success w-100 mb-2">Singleplayer</button>
        <button id="replay-list-btn" class="btn btn-outline-primary w-100 mb-2 mt-2">Saved Replays</button>
        <select id="theme-select" class="form-select mb-3">
          <option value="light">Light</option>
          <option value="dark">Dark</option>
          <option value="blue">Blue</option>
          <option value="green">Green</option>
          <option value="pink">Pink</option>
          <option value="red">Red</option>
        </select>
        <div id="xp-info" class="mb-2 text-muted small"></div>
        <button id="leaderboard-btn" class="btn btn-outline-secondary w-100">Leaderboard</button>
      </div>
    </div>
  </div>
</div>

<!-- MAZE SCREEN -->
<div id="maze-screen" class="maze-container d-none">
  <div id="maze-grid" class="maze-grid" aria-hidden="false"></div>
  <div id="keystrokes" class="keystrokes"></div>
  <div id="stopwatch" class="stopwatch">00:00.000</div>
  <button id="back-btn" class="btn btn-secondary back-btn">Exit</button>
</div>

<script>
/* ---------------- DOM ---------------- */
const usernameScreen = document.getElementById('username-screen');
const usernameInput = document.getElementById('username-input');
const continueBtn = document.getElementById('continue-btn');
const connectScreen = document.getElementById('connect-screen');
const mazeScreen = document.getElementById('maze-screen');
const mazeGrid = document.getElementById('maze-grid');
const themeSelect = document.getElementById('theme-select');
const xpInfo = document.getElementById('xp-info');
const singleBtn = document.getElementById('single-btn');
const replayListBtn = document.getElementById('replay-list-btn');
const leaderboardBtn = document.getElementById('leaderboard-btn');
const backBtn = document.getElementById('back-btn');
const keystrokesDiv = document.getElementById('keystrokes');
const stopwatchDisplay = document.getElementById('stopwatch');
const serverStatusPill = document.getElementById('server-status-pill');
const globalStatus = document.getElementById('global-status');

/* ---------------- Game Settings ---------------- */
const size = 21, cellPx = 25;
let maze=[], player={x:1,y:1}, endCell={x:size-2,y:size-2};
let moving=false, gameWon=false, startTime=null, timerInterval=null;
let moves=[], replayMode=false;
let xp=parseInt(localStorage.getItem('maze_xp'))||0;
let level=Math.floor(xp/100);
let leaderboard=JSON.parse(localStorage.getItem('maze_leaderboard')||'[]');
let token=localStorage.getItem('supermaze_token')||null;

/* ---------------- Helpers ---------------- */
function clone2D(arr){return arr.map(r=>r.slice())}
function now(){return performance.now()}
function formatTime(ms){if(!ms)return"00:00.000";const s=ms/1000,m=Math.floor(s/60),sec=Math.floor(s%60),msr=Math.floor(ms%1000);return`${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}.${String(msr).padStart(3,'0')}`}

/* ---------------- XP ---------------- */
function updateXPDisplay(){xpInfo.textContent=`${username||'Guest'} | Level ${level} | XP: ${xp}`;}

/* ---------------- Token Fetch ---------------- */
async function fetchToken(){
  try{
    const resp=await fetch('https://supermaze-auth.onrender.com/api/new-token',{mode:'cors'});
    const data=await resp.json();
    token=data.token;
    localStorage.setItem('supermaze_token',token);
    return token;
  }catch(e){
    alert('Failed to fetch token: '+e);
    return null;
  }
}

/* ---------------- Username ---------------- */
let username=localStorage.getItem('maze_username')||'';
if(username && token){
  usernameScreen.classList.add('d-none');
  connectScreen.classList.remove('d-none');
  updateXPDisplay();
}
continueBtn.onclick=async()=>{
  const name=usernameInput.value.trim();
  if(!name)return alert('Enter a username!');
  username=name;
  localStorage.setItem('maze_username',username);

  if(!token) await fetchToken();
  
  usernameScreen.classList.add('d-none');
  connectScreen.classList.remove('d-none');
  updateXPDisplay();
};

/* ---------------- Theme ---------------- */
themeSelect.onchange=()=>document.body.className='theme-'+themeSelect.value;

/* ---------------- Maze Generator ---------------- */
function initWallGrid(){maze=new Array(size);for(let y=0;y<size;y++)maze[y]=new Array(size).fill(1);}
function carveMaze(){
  initWallGrid();
  const stack=[]; const start={x:1,y:1};
  maze[start.y][start.x]=0; stack.push(start);
  const dirs=[{dx:0,dy:-2},{dx:2,dy:0},{dx:0,dy:2},{dx:-2,dy:0}];
  while(stack.length){
    const cur=stack[stack.length-1];
    const neighbors=[];
    for(const d of dirs){
      const nx=cur.x+d.dx,ny=cur.y+d.dy;
      if(ny>0&&ny<size-1&&nx>0&&nx<size-1&&maze[ny][nx]===1) neighbors.push({x:nx,y:ny,via:d});
    }
    if(neighbors.length===0) stack.pop();
    else{
      const n=neighbors[Math.floor(Math.random()*neighbors.length)];
      maze[cur.y+n.via.dy/2][cur.x+n.via.dx/2]=0;
      maze[n.y][n.x]=0;
      stack.push({x:n.x,y:n.y});
    }
  }
}
function randomEmpty(){
  let attempts=0;
  while(attempts++<10000){
    const x=1+Math.floor(Math.random()*(size-2));
    const y=1+Math.floor(Math.random()*(size-2));
    if(maze[y][x]===0)return {x,y};
  }
  return {x:1,y:1};
}
function placePlayerAndEnd(){
  player=randomEmpty(); endCell=randomEmpty();
  let tries=0;
  while((Math.abs(player.x-endCell.x)+Math.abs(player.y-endCell.y))<Math.floor(size/2)&&tries++<2000)
    endCell=randomEmpty();
  console.log("Player:",player,"End:",endCell);
}
function generateMaze(){carveMaze(); placePlayerAndEnd();}

/* ---------------- Render ---------------- */
function renderMaze(ghostPos=null){
  mazeGrid.innerHTML='';
  mazeGrid.style.gridTemplateColumns=`repeat(${size}, ${cellPx}px)`;
  mazeGrid.style.gridTemplateRows=`repeat(${size}, ${cellPx}px)`;
  const frag=document.createDocumentFragment();
  for(let y=0;y<size;y++){
    for(let x=0;x<size;x++){
      const d=document.createElement('div');d.className='cell';
      if(maze[y][x]===1)d.classList.add('wall');
      if(x===player.x&&y===player.y&&!(ghostPos&&ghostPos.x===x&&ghostPos.y===y))d.classList.add('player');
      if(x===endCell.x&&y===endCell.y)d.classList.add('end');
      if(ghostPos&&ghostPos.x===x&&ghostPos.y===y)d.classList.add('ghost');
      frag.appendChild(d);
    }
  }
  mazeGrid.appendChild(frag);
}

/* ---------------- Movement ---------------- */
const keys={w:false,a:false,s:false,d:false,ArrowUp:false,ArrowDown:false,ArrowLeft:false,ArrowRight:false};
const arrowMap={W:'ArrowUp',A:'ArrowLeft',S:'ArrowDown',D:'ArrowRight'};
function updateKeystrokes(){
  const layout=['W','A','S','D']; keystrokesDiv.innerHTML='';
  layout.forEach(k=>{
    const span=document.createElement('span'); span.textContent=k;
    const lower=k.toLowerCase(),arrow=arrowMap[k];
    if(keys[lower]||keys[arrow])span.style.background='limegreen';
    keystrokesDiv.appendChild(span);
  });
}
document.addEventListener('keydown',e=>{
  if(replayMode||gameWon)return;
  if(document.activeElement.tagName==='INPUT')return;
  const key=e.key;
  if(!['w','a','s','d','ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(key))return;
  e.preventDefault();
  if(keys[key])return; keys[key]=true; updateKeystrokes();
  if(!startTime) startStopwatch();
  let nx=player.x,ny=player.y;
  if(key==='w'||key==='ArrowUp')ny--;
  if(key==='s'||key==='ArrowDown')ny++;
  if(key==='a'||key==='ArrowLeft')nx--;
  if(key==='d'||key==='ArrowRight')nx++;
  if(maze[ny]&&maze[ny][nx]===0){
    player.x=nx; player.y=ny;
    const t=startTime?Math.max(0,Math.round(now()-startTime)):0;
    moves.push({x:nx,y:ny,t});
    renderMaze(); checkVictory();
  }
});
document.addEventListener('keyup',e=>{if(['w','a','s','d','ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)){keys[e.key]=false;updateKeystrokes()}});

/* ---------------- Stopwatch ---------------- */
function startStopwatch(){startTime=now(); stopwatchDisplay.textContent=formatTime(0); timerInterval=setInterval(()=>{stopwatchDisplay.textContent=formatTime(Math.round(now()-startTime))},30);}
function stopStopwatch(){clearInterval(timerInterval); timerInterval=null;}
function resetStopwatch(){stopStopwatch(); startTime=null; stopwatchDisplay.textContent="00:00.000";}

/* ---------------- Victory ---------------- */
function checkVictory(){
  if(player.x===endCell.x && player.y===endCell.y && !gameWon){
    gameWon=true; stopStopwatch();
    const totalTime=Math.round(now()-(startTime||now()));
    addXP(50); saveRun(totalTime); showVictory(totalTime);
  }
}
function showVictory(totalTime){
  const overlay=document.createElement('div');
  Object.assign(overlay.style,{position:'absolute',inset:'0',display:'flex',flexDirection:'column',justifyContent:'center',alignItems:'center',background:'rgba(0,0,0,0.8)',zIndex:9999});
  const title=document.createElement('h1'); title.innerText='ðŸ† VICTORY!'; title.style.color='gold'; title.style.fontSize='48px';
  const timeText=document.createElement('h4'); timeText.innerText=`Time: ${formatTime(totalTime)}`; timeText.style.color='#fff';
  const replayBtn=document.createElement('button'); replayBtn.className='btn btn-primary mt-3'; replayBtn.textContent='Replay Run';
  replayBtn.onclick=()=>{overlay.remove(); const last=leaderboard[leaderboard.length-1]; if(last) playReplay(last);};
  const menuBtn=document.createElement('button'); menuBtn.className='btn btn-secondary mt-3'; menuBtn.textContent='Return to Menu';
  menuBtn.onclick=()=>{overlay.remove(); mazeScreen.classList.add('d-none'); connectScreen.classList.remove('d-none'); resetGame();};
  overlay.append(title,timeText,replayBtn,menuBtn); mazeScreen.appendChild(overlay);
}

/* ---------------- XP & Runs ---------------- */
function addXP(amount){xp+=amount; level=Math.floor(xp/100); localStorage.setItem('maze_xp',xp); updateXPDisplay();}
function saveRun(time){
  const run={username:username||'Guest',time,moves:moves.slice(),xp,date:new Date().toISOString(),mazeSnapshot:clone2D(maze),startPos:{...moves.length?moves[0]:player}};
  leaderboard.push(run); localStorage.setItem('maze_leaderboard',JSON.stringify(leaderboard));
  if(token) fetch(`https://supermaze-auth.onrender.com/api/stats/${token}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({xp,time,run})});
}

/* ---------------- Reset ---------------- */
function resetGame(){generateMaze(); renderMaze(); moves=[]; gameWon=false; replayMode=false; resetStopwatch();}

/* ---------------- Initialize ---------------- */
generateMaze(); renderMaze();

/* ---------------- Start Singleplayer ---------------- */
singleBtn.onclick=()=>{connectScreen.classList.add('d-none'); mazeScreen.classList.remove('d-none'); resetGame();}
backBtn.onclick=()=>{mazeScreen.classList.add('d-none'); connectScreen.classList.remove('d-none'); resetGame();}
</script>
</body>
</html>
